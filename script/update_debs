#!/usr/bin/python

import os
import sys
from subprocess import Popen, PIPE, call

def comp(list1, list2):
	for item in list1:
		if item in list2:
			return True
	return False

apt_hold_process = Popen(["dpkg", "--get-selections"],stdout=PIPE).communicate()[0].splitlines()
apt_hold = []
for word in apt_hold_process:
	if "hold" in word:
		word = word.split()
		apt_hold.append(word[0])
	if "aptitude" in word:
		word = word.split()
		if word[1] == "install" and word[0] == "aptitude":
			aptitude = 1;


if aptitude == 1:
	aptitude_hold_process = Popen(["aptitude","search","~ahold"],stdout=PIPE).communicate()[0].splitlines()
	for word in aptitude_hold_process:
		word = word.split()
		apt_hold.append(word[1])


installed_process = Popen(["dpkg","-l","szarp-*"],stdout=PIPE).communicate()[0].splitlines()
installed = []
for line in installed_process:
	if "szarp" in line:
		line = line.split()
		if line[0] == "ii" and "szarp" in line[1]:
			if not "custom" in line[2]:
				installed.append(line[1])
			else:
				apt_hold.append(line[1])
		if line[0] == "hi" and "szarp" in line[1]:
			exit("jeden z pakietow szarpa jest holdowany")

dependencies = []
for szarp in installed:
	dependencies_process = Popen(["apt-cache", "show", szarp],stdout=PIPE).communicate()[0].splitlines()
	for line in dependencies_process:
		if "Depends:" in line:
			line = line.split()
			for word in line:
				if not word == "Depends:" and not word == "|":
					if word != "(>=" and not ")" in word:
						word = word.replace(",","")
						dependencies.append(word)

total = set(dependencies) & set(apt_hold)
if comp(dependencies, apt_hold):
	print "Z powodu zachowanych paczek nie update'ujemy:"
	for pkg in total:
		print pkg
	exit()

call(["apt-get","update"])
for szarp in installed:
	call(["apt-get","install","--only-upgrade",szarp,"-y"])
